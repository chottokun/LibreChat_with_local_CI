import requests

BASE_URL = "http://localhost:8000"
API_KEY = "your_secret_key"
HEADERS = {"X-API-Key": API_KEY}

def test_vulnerability():
    print("Testing for vulnerability (detailed error exposure)...")
    data = {"code": "print('hello')", "session_id": "test_session"}
    try:
        response = requests.post(f"{BASE_URL}/run/exec", headers=HEADERS, json=data)
        print(f"Status Code: {response.status_code}")
        print(f"Response: {response.json()}")

        detail = response.json().get("detail", "")
        if "Failed to start sandbox:" in detail and "docker.errors.ImageNotFound" in detail:
            print("VULNERABILITY CONFIRMED: Detailed error message exposed.")
            return True
        elif response.status_code == 500:
            print("Received 500 error, but checking if it's generic...")
            print(f"Detail: {detail}")
            if detail == "Failed to start sandbox. Please contact an administrator.":
                print("FIX VERIFIED: Generic error message received.")
                return False
        else:
            print("Unexpected response.")
    except Exception as e:
        print(f"Error during request: {e}")
    return False

if __name__ == "__main__":
    test_vulnerability()
